<html lang="ru">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset=utf-8>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/inter-ui/3.19.3/inter.css"
          integrity="sha512-3kSeajrEqMrItwRkYz09bOsHsl4/wpoT6mgw5Aw+eSLweQtX7kZp2P/Dm7hnUg/TrbTGesAgCPwvZpllhuROTw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <title>Генератор картинок</title>

</head>
<body>
<form name="test">
    <label for="title">Заголовок</label>
    <br/>
    <input type="text" id="title" size="60" value="АМИТОЗ">
    <br/>

    <label for="text">Текст</label>
    <br/><textarea cols="60" id="text" rows="10">
прямое деление клетки путем перетяжки или инвагинации.

Амитоточеское деление ядра не сопровождается цитокинезом, в результате образуются двуядерные и многоядеррные клетки.</textarea>
    <br/>
    <br/>
    <button type="button"
            onclick="draw(document.getElementById('title').value, document.getElementById('text').value)">
        Сгененировать
    </button>
    <button type="button" onclick="saveImage()">Сохранить</button>
</form>

<script type="text/javascript">
    const width = 1500
    const height = 1500
    const padding_left = 280
    const padding_right = 280
    const padding_top = 430
    const line_break_size = 1.4
    const title_size = 60;
    const text_size = 40;
    const empty_line_break_factor = 0.5;

    function draw(title, text) {
        const imageObj = new Image();
        imageObj.src = "assets/images/template_with_text.jpg";

        imageObj.onload = function () {
            context.drawImage(imageObj, 0, 0);
            context.font = `600 ${title_size}px Inter`;
            context.fillText(title, padding_left, padding_top);

            context.font = `${text_size}px Inter`;
            let yOffset = padding_top + title_size * line_break_size
            const words = [...text.replaceAll("\n", " \n ").split(" "), "\n"];
            let currentLine = ""

            words.forEach(word => {
                const currentWidth = context.measureText((currentLine + " " + word).trim()).width;

                if (currentWidth < width - padding_right - padding_left && word !== "\n") {
                    currentLine += " " + word;
                    console.log("part: " + currentLine);
                } else {
                    context.fillText(currentLine.trim(), padding_left, yOffset);
                    console.log(currentLine.trim())
                    let line_break_factor = 1
                    if (currentLine.trim() === "") {
                        line_break_factor = empty_line_break_factor;
                    }
                    yOffset += text_size * line_break_size * line_break_factor
                    currentLine = word;
                }
            });
        }
    }

    function saveImage() {
        const gh = canvas.toDataURL('png');

        const a = document.createElement('a');
        a.href = gh;
        a.download = 'image.png';

        a.click()
    }

    let canvas, context;
    document.fonts.ready.then(() => {
        canvas = document.createElement("canvas");
        canvas.setAttribute("id", "idCanvas");
        canvas.setAttribute("width", String(width));
        canvas.setAttribute("height", String(height));
        document.body.appendChild(canvas);
        context = canvas.getContext('2d');

        draw(document.getElementById('title').value, document.getElementById('text').value)
    });



</script>
</body>
</html>
